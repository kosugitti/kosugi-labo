name: Monitor Server Status

on:
  schedule:
    # 毎時0分に実行 (UTC)
    - cron: '0 * * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check server status update time
        id: check
        run: |
          # JSONファイルから更新時刻を取得
          UPDATED_AT=$(cat docs/server_status.json | jq -r '.updated_at')
          echo "Last update: $UPDATED_AT"

          # 更新時刻をUnix timestampに変換
          UPDATED_TS=$(date -d "$UPDATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${UPDATED_AT%+*}" +%s 2>/dev/null)
          NOW_TS=$(date +%s)

          # 差分を計算（秒）
          DIFF=$((NOW_TS - UPDATED_TS))
          DIFF_HOURS=$((DIFF / 3600))

          echo "Time since last update: $DIFF_HOURS hours ($DIFF seconds)"

          # 1時間（3600秒）以上古いかチェック
          if [ $DIFF -gt 3600 ]; then
            echo "stale=true" >> $GITHUB_OUTPUT
            echo "hours=$DIFF_HOURS" >> $GITHUB_OUTPUT
          else
            echo "stale=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if stale
        if: steps.check.outputs.stale == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const hours = '${{ steps.check.outputs.hours }}';

            // 既存の同じタイトルのIssueがないかチェック
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'server-alert'
            });

            const existingIssue = issues.data.find(i =>
              i.title.includes('サーバーステータス更新停止')
            );

            if (existingIssue) {
              // 既存Issueにコメント追加
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `まだ更新が停止しています（${hours}時間経過）\n\n確認時刻: ${new Date().toISOString()}`
              });
            } else {
              // 新規Issue作成
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ サーバーステータス更新停止アラート',
                body: `## 警告\n\nサーバーステータスの更新が **${hours}時間以上** 停止しています。\n\nAl-Khwarizumiに問題が発生している可能性があります。\n\n### 確認事項\n- [ ] Al-Khwarizumiは起動しているか\n- [ ] cronジョブは動作しているか (\`crontab -l\`)\n- [ ] ネットワーク接続は正常か\n\n---\n検出時刻: ${new Date().toISOString()}`,
                labels: ['server-alert']
              });
            }
